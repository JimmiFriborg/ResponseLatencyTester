# v4.0 Implementation Plan - Gradual Feature Rollout

## Overview
This document provides a detailed, step-by-step implementation plan for Hardware Latency Tester v4.0. Each phase builds incrementally on the previous one, ensuring we always have a working product.

---

## Phase 1: Video Player Foundation üé¨
**Timeline**: Days 1-3
**Goal**: Basic video playback with frame-accurate control

### Tasks
1. **Setup v4.0 Base Structure**
   - [x] Create `latency-tester-v4.0.html` based on v3.8
   - [ ] Add video player React component scaffold
   - [ ] Update UI layout to accommodate video section
   - [ ] Add video file upload/selection UI

2. **HTML5 Video Integration**
   - [ ] Implement controlled video element
   - [ ] Add basic controls: play, pause, mute, volume
   - [ ] Display video metadata (duration, resolution, FPS)
   - [ ] Auto-detect FPS from video metadata
   - [ ] Fallback FPS input if metadata missing

3. **Frame-Accurate Navigation**
   - [ ] Implement frame calculation: `frameNumber = Math.floor(currentTime * fps)`
   - [ ] Previous/Next frame buttons
   - [ ] Frame counter display: `Frame 1234 / 5400`
   - [ ] Jump to frame input box
   - [ ] Scrubber/seekbar with frame snapping

4. **Keyboard Shortcuts**
   - [ ] Space: Play/Pause
   - [ ] Left/Right Arrow: Previous/Next frame
   - [ ] J/K/L: Rewind/Pause/Forward
   - [ ] I/O: Set In/Out points
   - [ ] M: Add marker at current frame

5. **Timecode System**
   - [ ] Frame to timecode conversion: `HH:MM:SS:FF`
   - [ ] Timecode display above video
   - [ ] Timecode input for direct seeking
   - [ ] Support both drop-frame and non-drop-frame

**Deliverable**: Can load MP4/MOV videos and navigate frame-by-frame
**Testing**: Load sample video, verify frame stepping accuracy
**File**: `latency-tester-v4.0-alpha1.html` (~105KB)

---

## Phase 2: Timeline & Manual Markers üìç
**Timeline**: Days 4-7
**Goal**: Click to add markers, full manual workflow

### Tasks
1. **Timeline Component**
   - [ ] Create timeline canvas below video
   - [ ] Draw time ruler with tick marks (1s, 100ms, 10ms)
   - [ ] Animated playhead synced with video.currentTime
   - [ ] Click timeline to seek video
   - [ ] Zoom controls (fit, 10s, 1s, 100ms views)

2. **Marker Data Structure**
   - [ ] Define marker schema (id, type, frame, timecode, notes, axis)
   - [ ] Marker state management in React
   - [ ] LocalStorage persistence
   - [ ] Undo/redo for marker operations

3. **Marker Placement**
   - [ ] Click timeline to add marker at playhead
   - [ ] Marker type selector (dropdown or toolbar)
   - [ ] Marker color coding (green, pink, cyan, lemon, red, yellow)
   - [ ] Drag marker to adjust timing
   - [ ] Snap to frame boundaries when dragging

4. **Marker Editing**
   - [ ] Click marker to select
   - [ ] Selected marker highlights on timeline
   - [ ] Properties panel: type, timecode, notes, axis
   - [ ] Edit marker properties inline
   - [ ] Delete marker (Del key or button)
   - [ ] Bulk selection (Shift+click, Ctrl+click)

5. **Marker List View**
   - [ ] Table showing all markers sorted by time
   - [ ] Columns: Frame, Timecode, Type, Axis, Notes
   - [ ] Click row to jump video to marker
   - [ ] Filter markers by type
   - [ ] Search markers by notes

6. **CSV Export (DaVinci Compatible)**
   - [ ] Export markers to CSV in DaVinci format
   - [ ] Include all marker metadata
   - [ ] Maintain compatibility with v3.8 CSV import

**Deliverable**: Complete manual marker workflow, CSV export
**Testing**: Mark up a test video completely, export CSV, verify format
**File**: `latency-tester-v4.0-alpha2.html` (~115KB)

---

## Phase 3: Audio Waveform Visualization üéµ
**Timeline**: Days 8-10
**Goal**: Visual audio analysis for precise marker placement

### Tasks
1. **WaveSurfer.js Integration**
   - [ ] Add WaveSurfer.js via CDN (~50KB)
   - [ ] Initialize waveform from video audio track
   - [ ] Render waveform canvas below timeline
   - [ ] Sync waveform with video playback

2. **Waveform Controls**
   - [ ] Zoom in/out buttons
   - [ ] Scroll/pan when zoomed
   - [ ] Mini-map overview for navigation
   - [ ] Waveform color customization (user setting)

3. **Waveform-Timeline Integration**
   - [ ] Show markers on waveform as vertical lines
   - [ ] Click waveform to add marker
   - [ ] Drag markers on waveform
   - [ ] Playhead synced across video, timeline, waveform

4. **Audio Analysis Tools**
   - [ ] Amplitude display (peak, RMS)
   - [ ] Frequency analysis (optional, if needed)
   - [ ] Silent region detection (for debugging)

5. **Waveform Caching**
   - [ ] Generate waveform once, cache to IndexedDB
   - [ ] Progress indicator during generation
   - [ ] Cache invalidation on video change

**Deliverable**: Audio waveform synced with video and markers
**Testing**: Verify waveform accuracy, test zoom/pan, verify caching
**File**: `latency-tester-v4.0-alpha3.html` (~120KB)

---

## Phase 4: Pattern Recognition System ü§ñ
**Timeline**: Days 11-15
**Goal**: Auto-detect repeated marker patterns

### Tasks
1. **Pattern Template Creation UI**
   - [ ] "Create Pattern" button
   - [ ] Select region tool (drag on timeline to select range)
   - [ ] Mark subsections within selected region
   - [ ] Name pattern (e.g., "AB6 TagOn Sequence")
   - [ ] Link pattern to hardware profile
   - [ ] Save pattern template to localStorage

2. **Audio Signature Extraction**
   - [ ] Extract audio data for selected region
   - [ ] Compute FFT (Fast Fourier Transform)
   - [ ] Generate amplitude envelope
   - [ ] Store signature with template

3. **Video Signature Extraction (Basic)**
   - [ ] Extract frames for selected region
   - [ ] Compute frame differences (motion detection)
   - [ ] Optional: Edge detection, color histogram
   - [ ] Store signature with template

4. **Pattern Matching Algorithm**
   - [ ] Sliding window search through video
   - [ ] Compute correlation score (audio + video)
   - [ ] Threshold filtering (user-adjustable sensitivity slider)
   - [ ] Generate candidate list with confidence scores

5. **Auto-Detection UI**
   - [ ] "Auto-Detect" button for selected pattern
   - [ ] Progress bar during analysis
   - [ ] Results panel showing candidates
   - [ ] Candidate list: time, confidence %, preview button
   - [ ] Approve/reject each candidate
   - [ ] Batch approve all above confidence threshold

6. **Pattern Library**
   - [ ] List of saved patterns
   - [ ] Edit/delete patterns
   - [ ] Export/import patterns (JSON)
   - [ ] Usage statistics (times used, success rate)

7. **Learning System (Future)**
   - [ ] Track user approvals/rejections
   - [ ] Adjust confidence thresholds based on feedback
   - [ ] Improve pattern matching over time

**Deliverable**: Auto-detect marker patterns with 80%+ accuracy
**Testing**: Create pattern from known sequence, verify detection throughout video
**File**: `latency-tester-v4.0-beta1.html` (~135KB)

---

## Phase 5: Hardware Management System üîß
**Timeline**: Days 16-18
**Goal**: Multi-hardware testing support

### Tasks
1. **Hardware Profile Data Structure**
   - [ ] Define profile schema (id, name, type, revision, firmware, requirements)
   - [ ] Profile state management
   - [ ] LocalStorage persistence
   - [ ] Import/export profiles (JSON)

2. **Hardware Profile CRUD**
   - [ ] "Hardware Profiles" navigation tab
   - [ ] Create new profile form
   - [ ] Profile list view
   - [ ] Edit profile (inline or modal)
   - [ ] Delete profile with confirmation
   - [ ] Duplicate profile

3. **Profile Configuration**
   - [ ] Hardware type (Tag Experience, custom, etc.)
   - [ ] Manufacturer field
   - [ ] Hardware revision (dropdown or text)
   - [ ] Firmware version
   - [ ] Test requirements (max latency, ranges)
   - [ ] Default patterns (multi-select from library)
   - [ ] Notes/description field

4. **Profile-Test Case Linking**
   - [ ] Select hardware profile when creating test case
   - [ ] Auto-populate requirements from profile
   - [ ] Override requirements per test case (optional)
   - [ ] Display profile info in test execution view

5. **Version Comparison**
   - [ ] Compare test results across profiles
   - [ ] Side-by-side profile comparison view
   - [ ] Historical data per profile
   - [ ] Migration warnings on requirement changes

6. **Profile Templates**
   - [ ] Provide default profiles (AB6, example configs)
   - [ ] Template gallery for quick start
   - [ ] Community sharing (future)

**Deliverable**: Full hardware configuration management
**Testing**: Create multiple profiles, link to test cases, verify requirement propagation
**File**: `latency-tester-v4.0-beta2.html` (~140KB)

---

## Phase 6: Enhanced Test Execution üìä
**Timeline**: Days 19-21
**Goal**: Integrate video evidence with test results

### Tasks
1. **Video-Linked Executions**
   - [ ] Add video source reference to execution data
   - [ ] Display video thumbnail in execution list
   - [ ] Jump to execution in video player
   - [ ] Show execution markers on timeline

2. **Video Clip Extraction**
   - [ ] Extract frames around markers (¬±2s context)
   - [ ] Generate frame image from canvas
   - [ ] Embed frames in test report
   - [ ] Optional: GIF generation for marker sequences

3. **Enhanced Report View**
   - [ ] Include video frames in PDF export
   - [ ] Timeline screenshots showing all markers
   - [ ] Annotated frames with latency overlays
   - [ ] Side-by-side comparisons with video evidence

4. **Multi-Video Support**
   - [ ] Multiple video files per test case
   - [ ] Video selector dropdown
   - [ ] Sync markers across videos (if same hardware)

**Deliverable**: Test reports with embedded video evidence
**Testing**: Generate report, verify frames are embedded correctly
**File**: `latency-tester-v4.0-beta3.html` (~145KB)

---

## Phase 7: Advanced Export & Polish üì§
**Timeline**: Days 22-25
**Goal**: Professional-grade export options

### Tasks
1. **Export Format Options**
   - [ ] CSV (DaVinci compatible, v3.8 compatible)
   - [ ] JSON (complete test data)
   - [ ] PDF (professional report with video frames)
   - [ ] HTML (standalone report viewer)
   - [ ] Marker timeline screenshot (PNG)

2. **PDF Export Enhancement**
   - [ ] Professional styling
   - [ ] Company logo support
   - [ ] Custom header/footer
   - [ ] Table of contents
   - [ ] Executive summary
   - [ ] Detailed results per execution

3. **Batch Export**
   - [ ] Export multiple test cases at once
   - [ ] Zip file download with all exports
   - [ ] Progress indicator for large exports

4. **Annotated Video Export (Optional)**
   - [ ] Integrate FFmpeg.wasm (lazy load, ~30MB)
   - [ ] Overlay markers on video
   - [ ] Burn-in timecode
   - [ ] Latency measurement overlays
   - [ ] Pass/fail indicators
   - [ ] Export as new MP4 file

5. **Performance Optimization**
   - [ ] Lazy load WaveSurfer only when video loaded
   - [ ] Virtual scrolling for 1000+ markers
   - [ ] Debounce waveform rendering
   - [ ] Progressive video loading
   - [ ] Memory leak prevention

6. **UI/UX Polish**
   - [ ] Loading states for all async operations
   - [ ] Error handling with user-friendly messages
   - [ ] Confirmation dialogs for destructive actions
   - [ ] Keyboard shortcut reference (? key)
   - [ ] Onboarding tutorial (first-time use)
   - [ ] Tooltips for all controls
   - [ ] Responsive layout (desktop focus, but usable on tablet)

7. **Dark Mode**
   - [ ] Dark color scheme
   - [ ] Toggle switch in settings
   - [ ] Persist preference
   - [ ] Adjust waveform colors for dark mode

8. **Documentation**
   - [ ] User guide (in-app help)
   - [ ] Video tutorial (optional)
   - [ ] Migration guide from DaVinci workflow
   - [ ] API documentation (for pattern files, profiles)
   - [ ] Changelog

**Deliverable**: Production-ready v4.0
**Testing**: Full regression testing, user acceptance testing
**File**: `latency-tester-v4.0.html` (~150KB, or more if FFmpeg included)

---

## Phase 8: Testing & Release üöÄ
**Timeline**: Days 26-30
**Goal**: Comprehensive testing and v4.0 launch

### Tasks
1. **Cross-Browser Testing**
   - [ ] Chrome (primary)
   - [ ] Firefox
   - [ ] Safari
   - [ ] Edge
   - [ ] Test video codec support
   - [ ] Test performance with large videos

2. **Regression Testing**
   - [ ] All v3.8 features still work
   - [ ] CSV import/export compatibility
   - [ ] LocalStorage migration
   - [ ] Test case data integrity

3. **Performance Testing**
   - [ ] 4K video playback
   - [ ] 60 FPS video navigation
   - [ ] 120 FPS video support
   - [ ] 1000+ markers
   - [ ] 1-hour video files
   - [ ] Memory usage profiling

4. **User Acceptance Testing**
   - [ ] Real workflow testing with actual users
   - [ ] Gather feedback
   - [ ] Fix critical bugs
   - [ ] Adjust UI based on feedback

5. **Documentation Review**
   - [ ] Proofread all docs
   - [ ] Update screenshots
   - [ ] Verify all links
   - [ ] Add FAQ section

6. **Release Preparation**
   - [ ] Create release notes
   - [ ] Tag v4.0 in git
   - [ ] Merge to main
   - [ ] Create GitHub release

**Deliverable**: v4.0 release - DaVinci Resolve replacement
**File**: `latency-tester-v4.0.html` (final production build)

---

## Development Guidelines

### Code Quality
- **React best practices**: Hooks, functional components, proper state management
- **Performance**: Memoization, lazy loading, virtual scrolling
- **Accessibility**: ARIA labels, keyboard navigation, screen reader support
- **Error handling**: Try/catch, user-friendly errors, graceful degradation

### Testing Strategy
- **Manual testing**: After each phase
- **User feedback**: Regular check-ins
- **Browser testing**: Every 2-3 phases
- **Performance testing**: Phases 3, 5, 7

### Git Workflow
- **Branch**: `claude/v4.0-development`
- **Commit frequency**: After each completed task
- **Commit messages**: Clear, descriptive
- **Push frequency**: End of each phase
- **Merge to main**: After Phase 8 (v4.0 release)

### File Management
- **Alpha releases**: v4.0-alpha1, alpha2, alpha3
- **Beta releases**: v4.0-beta1, beta2, beta3
- **Release candidates**: v4.0-rc1, rc2 (if needed)
- **Final release**: v4.0

---

## Risk Management

### High-Risk Items
1. **Pattern recognition accuracy**: Start simple, iterate
   - Mitigation: User review step, adjustable confidence threshold

2. **Large video performance**: Test early with real files
   - Mitigation: Streaming, lazy loading, caching

3. **Browser compatibility**: Different codec support
   - Mitigation: Early testing, format recommendations, fallbacks

4. **Scope creep**: Many potential features
   - Mitigation: Stick to phase plan, defer nice-to-haves to v4.1

### Medium-Risk Items
1. **WaveSurfer.js integration**: External dependency
   - Mitigation: Test early, have fallback plan (Canvas-based waveform)

2. **Storage limits**: Large video metadata, waveform caches
   - Mitigation: IndexedDB, cache eviction policy, user warnings

3. **User adoption**: Learning curve from DaVinci
   - Mitigation: Good documentation, tutorial, migration guide

---

## Success Criteria

### Must-Have (v4.0 Release)
- ‚úÖ Load and play video files (MP4, MOV)
- ‚úÖ Frame-by-frame navigation
- ‚úÖ Manual marker placement and editing
- ‚úÖ Audio waveform visualization
- ‚úÖ Pattern recognition with 70%+ accuracy
- ‚úÖ Hardware profile management
- ‚úÖ CSV export (DaVinci compatible)
- ‚úÖ PDF report with video frames
- ‚úÖ All v3.8 features working
- ‚úÖ Single portable HTML file

### Nice-to-Have (v4.1+)
- Annotated video export (FFmpeg.wasm)
- Real-time video feed testing
- Cloud storage integration
- Multi-user collaboration
- Mobile app version
- Advanced ML pattern recognition

---

## Timeline Summary

| Phase | Days | Deliverable | File Size |
|-------|------|-------------|-----------|
| Phase 1 | 1-3 | Video player | ~105KB |
| Phase 2 | 4-7 | Manual markers | ~115KB |
| Phase 3 | 8-10 | Waveform | ~120KB |
| Phase 4 | 11-15 | Pattern recognition | ~135KB |
| Phase 5 | 16-18 | Hardware management | ~140KB |
| Phase 6 | 19-21 | Video-linked execution | ~145KB |
| Phase 7 | 22-25 | Export & polish | ~150KB |
| Phase 8 | 26-30 | Testing & release | Final |

**Total**: ~30 days (4-6 weeks)

---

## Questions for User Approval

Before starting implementation:

1. **Timeline**: Is 4-6 weeks acceptable for v4.0?
2. **Phases**: Any phases to prioritize or defer?
3. **Video formats**: Any specific codecs required beyond H.264/MP4?
4. **File sizes**: What's typical video size (GB)? Affects storage strategy.
5. **Pattern complexity**: How many patterns per hardware type?
6. **Export priority**: PDF most important, or annotated video export too?
7. **Deployment**: Will this stay as single HTML, or move to hosted app later?

---

**Prepared by**: Claude Code
**Date**: 2025-01-14
**Version**: 1.0 (Ready for approval)
