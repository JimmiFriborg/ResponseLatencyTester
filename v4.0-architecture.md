# Hardware Latency Tester v4.0 - Architecture Plan

## Vision
Transform the Hardware Latency Tester from a test result viewer into a **complete video testing workflow platform** that replaces DaVinci Resolve for hardware testing workflows.

---

## Core Objectives

1. **Eliminate DaVinci Resolve dependency** - Do everything in one tool
2. **Video-first workflow** - Load test videos, add markers directly
3. **Pattern recognition** - Auto-identify marker patterns throughout video
4. **Multi-hardware support** - Track different Tag types, HW revisions, versions
5. **Professional export** - Generate test reports with video evidence

---

## Technical Architecture

### 1. **Media Engine**

#### Video Player
- **Technology**: HTML5 `<video>` element with custom controls
- **Frame-by-frame control**: Use `currentTime` manipulation
- **Frame precision**: Calculate frame duration from FPS (1/fps seconds)
- **Playback controls**: Play, pause, step forward/back, jump to marker
- **Keyboard shortcuts**: Space (play/pause), Left/Right (frame step), J/K/L (rewind/pause/forward)

```javascript
// Frame-accurate seeking
const fps = 30; // or 60, 120, etc.
const frameDuration = 1 / fps;
video.currentTime = frameNumber * frameDuration;

// Frame stepping
const stepFrame = (direction) => {
  video.currentTime += direction * frameDuration;
};
```

#### Audio Waveform
- **Technology Option 1**: WaveSurfer.js (lightweight, proven)
- **Technology Option 2**: Web Audio API + Canvas (custom, more control)
- **Features**:
  - Visual waveform display synced with video
  - Click to seek in video
  - Zoom in/out for precision
  - Multiple tracks (if video has multiple audio channels)

#### Timeline System
- **Unified timeline** showing:
  - Video playhead position
  - Audio waveform
  - Marker lanes (TagOn, TagOff, Errors, Custom)
  - Pattern recognition zones
- **Sync**: All elements locked to video currentTime
- **Ruler**: Timecode display (HH:MM:SS:FF)

---

### 2. **Marker Management System**

#### Marker Types
```javascript
const MarkerTypes = {
  TAG_ON_TRIGGER: { color: 'green', label: 'TagOn', paired: true },
  TAG_ON_ACTIVATION: { color: 'pink', label: 'TagOn.Activation', paired: true },
  TAG_OFF_TRIGGER: { color: 'cyan', label: 'TagOff', paired: true },
  TAG_OFF_ACTIVATION: { color: 'lemon', label: 'TagOff.Activation', paired: true },
  ERROR_START: { color: 'red', label: 'Error Start', paired: true },
  ERROR_END: { color: 'red', label: 'Error End', paired: true },
  AXIS_MARKER: { color: 'yellow', label: 'Axis', paired: false },
  CUSTOM: { color: 'blue', label: 'Custom', paired: false }
};
```

#### Manual Marker Placement
- **Click on timeline** to add marker at current frame
- **Drag markers** to adjust timing
- **Context menu**: Edit, delete, change type
- **Marker inspector**: View/edit properties (time, type, notes, axis)
- **Batch operations**: Select multiple, delete, export

#### Marker Data Structure
```javascript
{
  id: 'unique_id',
  type: 'TAG_ON_TRIGGER',
  frameNumber: 1234,
  timecode: '00:00:41:04',
  timeMs: 41133,
  notes: 'X+ axis test',
  axis: 'X+',
  pairedWith: 'marker_id_2', // For paired markers
  videoSource: 'test_video_001.mp4',
  addedManually: true,
  confidence: null // For auto-detected markers
}
```

---

### 3. **Pattern Recognition Engine**

#### Training System
User selects a waveform/video section and marks subsections:
1. **Select pattern region** (e.g., 2-second clip)
2. **Mark key points within region**:
   - TagOn trigger point
   - TagOn activation point
3. **System learns pattern**:
   - Audio signature (waveform shape, frequency analysis)
   - Video signature (frame difference, motion detection)
   - Time delta between trigger and activation

#### Auto-Detection Algorithm
```javascript
// Pattern matching workflow
1. User defines template pattern
2. System extracts features:
   - Audio: FFT analysis, amplitude envelope, zero-crossing rate
   - Video: Frame difference, edge detection, color histogram
3. Sliding window search through entire video
4. Score potential matches using correlation
5. Threshold filtering (user-adjustable sensitivity)
6. Present candidates for user review
7. User approves/rejects suggestions
8. System learns from feedback (improve future detection)
```

#### Pattern Template Storage
```javascript
{
  id: 'template_001',
  name: 'AB6 TagOn Pattern',
  hardwareType: 'AB6',
  version: '1.1',
  markerSequence: [
    {
      type: 'TAG_ON_TRIGGER',
      audioSignature: { /* FFT data */ },
      videoSignature: { /* frame features */ },
      relativeTime: 0
    },
    {
      type: 'TAG_ON_ACTIVATION',
      audioSignature: { /* FFT data */ },
      videoSignature: { /* frame features */ },
      relativeTime: 133 // ms after trigger
    }
  ],
  confidence: 0.92,
  usageCount: 45,
  successRate: 0.89
}
```

---

### 4. **Hardware Configuration Management**

#### Hardware Profile System
```javascript
{
  id: 'hw_profile_001',
  name: 'AB6 Single Tile Tag',
  type: 'Tag Experience',
  manufacturer: 'Custom',
  hardwareRevision: 'Rev 1.1',
  firmwareVersion: '3.2.1',
  testRequirements: {
    maxLatency: 150, // ms
    minRespondRanges: { X: 5, Y: 5, Z: 5 }, // mm
    mustNotRespondRanges: { X: 25, Y: 25, Z: 25 } // mm
  },
  defaultPatterns: ['template_001', 'template_002'],
  notes: 'Single tile configuration for AB6 testing',
  createdDate: '2025-01-14',
  lastUsed: '2025-01-14'
}
```

#### Version Tracking
- Track hardware revision changes
- Compare test results across firmware versions
- Historical test data per hardware config
- Migration warnings when requirements change

---

### 5. **Workflow Integration**

#### Complete Testing Workflow
```
1. Create Test Case
   ↓
2. Select Hardware Profile (AB6 v1.1)
   ↓
3. Load Test Video (.mp4, .mov, .avi)
   ↓
4. Auto-detect or manually add markers
   ↓
5. Review/adjust marker timing
   ↓
6. Set test distances per axis
   ↓
7. Run validation against requirements
   ↓
8. Generate test report with video clips
   ↓
9. Export results (PDF, CSV, video with overlays)
```

#### Export Options
- **CSV Export**: Compatible with v3.8 format (for backup)
- **PDF Report**: Professional test report with embedded video frames
- **Video Export**: Annotated video with overlays showing:
  - Marker indicators
  - Latency measurements
  - Pass/fail indicators
  - Timecode burn-in
- **JSON Export**: Complete test data for archival

---

## Technology Stack

### Core Technologies
- **React 18**: UI framework (keep existing approach)
- **Tailwind CSS**: Styling (consistent with v3.8)
- **HTML5 Video API**: Video playback
- **Web Audio API**: Audio analysis and waveform generation
- **Canvas API**: Waveform rendering, timeline UI

### Recommended Libraries
- **WaveSurfer.js** (6.x): Audio waveform visualization
  - Lightweight (~50KB gzipped)
  - Timeline plugin for markers
  - Regions plugin for pattern selection
- **FFmpeg.wasm** (Optional, for advanced features):
  - Video frame extraction
  - Video export with overlays
  - Format conversion
  - Warning: Large bundle (~30MB), lazy load if used

### File Architecture
- **Single HTML file** (maintain portability)
- **Modular React components**:
  - `VideoPlayer` - Video control and display
  - `WaveformTimeline` - Audio waveform with markers
  - `MarkerEditor` - Marker management UI
  - `PatternRecognition` - Template creation and matching
  - `HardwareManager` - Hardware profile management
  - `TestExecution` - Current v3.8 execution view (enhanced)
  - `ReportExporter` - Multi-format export system

---

## Gradual Implementation Plan

### **Phase 1: Foundation (Week 1)**
**Goal**: Basic video player with timeline

- [ ] Add HTML5 video player component
- [ ] Implement frame-by-frame stepping
- [ ] Create basic timeline UI with playhead
- [ ] Add timecode display (HH:MM:SS:FF)
- [ ] Keyboard shortcuts for navigation
- [ ] File upload for video files
- [ ] FPS detection from video metadata

**Deliverable**: Can load video and navigate frame-by-frame

---

### **Phase 2: Manual Markers (Week 1-2)**
**Goal**: Click to add markers on timeline

- [ ] Implement marker placement on timeline (click to add)
- [ ] Marker types selector (dropdown or palette)
- [ ] Marker editing (drag, delete, change type)
- [ ] Marker list view (synced with timeline)
- [ ] Click marker to jump video to that frame
- [ ] Export markers to CSV (DaVinci format compatibility)

**Deliverable**: Can manually mark up videos completely

---

### **Phase 3: Audio Waveform (Week 2)**
**Goal**: Visual audio analysis

- [ ] Integrate WaveSurfer.js
- [ ] Render audio waveform below video
- [ ] Sync waveform with video playback
- [ ] Waveform zoom controls
- [ ] Click waveform to seek video
- [ ] Multiple zoom levels (full, 10s, 1s, 100ms views)

**Deliverable**: Can see and analyze audio patterns visually

---

### **Phase 4: Pattern Recognition (Week 3)**
**Goal**: Auto-detect marker patterns

- [ ] Pattern template creation UI
- [ ] Select region tool (start/end selection)
- [ ] Mark subsections within pattern
- [ ] Audio signature extraction (FFT analysis)
- [ ] Basic pattern matching (correlation)
- [ ] Auto-suggest markers with confidence scores
- [ ] Review/approve suggestion UI
- [ ] Pattern library management

**Deliverable**: Can auto-detect repeated patterns in video

---

### **Phase 5: Hardware Management (Week 3-4)**
**Goal**: Multi-hardware testing support

- [ ] Hardware profile CRUD interface
- [ ] Profile selector in test case creation
- [ ] Link patterns to hardware profiles
- [ ] Requirements templates per hardware
- [ ] Version comparison view
- [ ] Hardware profile import/export

**Deliverable**: Can manage different hardware configurations

---

### **Phase 6: Advanced Export (Week 4)**
**Goal**: Professional reporting with video evidence

- [ ] Video clip extraction (markers ± context frames)
- [ ] PDF report with embedded video frames
- [ ] Annotated video export (optional, using FFmpeg.wasm)
- [ ] Timeline screenshot export
- [ ] Multi-format batch export

**Deliverable**: Complete professional test reports with video

---

### **Phase 7: Polish & Optimization (Week 5)**
**Goal**: Production-ready release

- [ ] Performance optimization for large videos
- [ ] Lazy loading for large waveforms
- [ ] Progressive video loading
- [ ] Error handling and validation
- [ ] User onboarding / tutorial
- [ ] Comprehensive documentation
- [ ] Keyboard shortcut reference
- [ ] Dark mode support

**Deliverable**: v4.0 release - DaVinci Resolve replacement

---

## Data Migration Strategy

### v3.8 → v4.0 Compatibility
- **Import v3.8 test cases**: Full backward compatibility
- **CSV import still supported**: Can import DaVinci exports as before
- **Enhanced data structure**: Video source references added
- **Upgrade path**: v3.8 test cases become v4.0 executions with video links

### Storage Strategy
- **LocalStorage**: Settings, hardware profiles, pattern templates
- **IndexedDB**: Video files (for offline use), large test datasets
- **File system**: Video files remain external (user manages)
- **Export/Import**: Full project export as .json with optional video embedding

---

## UI/UX Enhancements

### Layout
```
┌─────────────────────────────────────────────────────────┐
│ Header: Hardware Latency Tester v4.0                   │
├────────┬────────────────────────────────────────────────┤
│ Side-  │  Video Player                                  │
│ bar    │  ┌──────────────────────────────┐              │
│        │  │                              │              │
│ • Test │  │       Video Display          │              │
│   Cases│  │                              │              │
│ • HW   │  └──────────────────────────────┘              │
│   Prof │  [Controls: ⏮ ⏪ ⏸ ⏩ ⏭]                       │
│ • Pat- │                                                │
│   terns│  Timeline / Waveform                          │
│        │  ╔═══╦════╦══╦═════════════╗                  │
│        │  ║   ▼    ▼  ▼             ║ ← Markers        │
│        │  ╠═══════════════════════════╣                │
│        │  ║ ～～～～～～～～～～～～～ ║ ← Audio wave  │
│        │  ╚═══════════════════════════╝                │
│        │  [00:00:12:15] ──────▶───── [00:01:30:22]    │
│        │                                                │
│        │  Marker List / Properties                     │
│        │  ┌────────────────────────────────┐           │
│        │  │ 1. TagOn (X+)    00:00:12:15   │           │
│        │  │ 2. TagOn.Act     00:00:12:20   │           │
│        │  └────────────────────────────────┘           │
└────────┴────────────────────────────────────────────────┘
```

### Navigation Tabs
- **Editor**: Video + timeline + markers (new)
- **Execution**: Current v3.8 test execution view (enhanced with video)
- **Comparison**: Multi-execution comparison (existing)
- **Report**: Test report generation (enhanced with video clips)
- **Hardware**: Hardware profile management (new)
- **Patterns**: Pattern library (new)

---

## Performance Considerations

### Large Video Files
- **Streaming playback**: Don't load entire video to memory
- **Waveform caching**: Generate once, cache to IndexedDB
- **Lazy marker rendering**: Virtual scrolling for 1000+ markers
- **Progressive loading**: Load video metadata first, then chunks

### Browser Compatibility
- **Target**: Modern evergreen browsers (Chrome 90+, Firefox 88+, Safari 14+, Edge 90+)
- **Video codecs**: H.264/AVC (universal), VP9 (optional), AV1 (future)
- **Audio**: AAC, MP3, Opus
- **Fallbacks**: Graceful degradation for older browsers

### File Size Budget
- **Target**: < 150KB for v4.0 HTML file (without video)
- **WaveSurfer.js**: ~50KB gzipped
- **React + Babel**: ~35KB (already in v3.8)
- **Tailwind**: ~10KB (purged)
- **Custom code**: ~55KB budget remaining

---

## Success Metrics

### v4.0 Goals
1. ✅ **Eliminate DaVinci Resolve**: Full workflow in one tool
2. ✅ **Faster marker creation**: 50% time reduction vs DaVinci
3. ✅ **Pattern recognition**: 80%+ accuracy on trained patterns
4. ✅ **Multi-hardware support**: Track 10+ different hardware configs
5. ✅ **Professional output**: PDF reports with video evidence
6. ✅ **Still portable**: Single HTML file (video files external)
7. ✅ **User adoption**: Replaces DaVinci for all HW testing

---

## Risk Mitigation

### Technical Risks
- **Large video files**: Use streaming, not full buffer
- **Browser memory limits**: IndexedDB for large datasets
- **Pattern recognition accuracy**: Start simple, iterate based on feedback
- **Cross-browser video support**: Test codec compatibility early

### User Adoption Risks
- **Learning curve**: Provide migration guide from DaVinci workflow
- **Missing features**: Prioritize must-haves, iterate on nice-to-haves
- **Performance issues**: Optimize early, test with real large videos

---

## Open Questions for User

1. **Video codec preference**: Any specific formats required beyond H.264?
2. **Average video file size**: How large are typical test videos?
3. **Pattern complexity**: How many different marker patterns per hardware type?
4. **Batch testing**: Need to process multiple videos at once?
5. **Real-time testing**: Live video feed testing or recorded only?
6. **Cloud storage**: Need cloud sync or fully local?
7. **Team collaboration**: Multi-user access needed?

---

## Next Steps

1. ✅ Review and approve architecture
2. [ ] Answer open questions
3. [ ] Create v4.0 branch
4. [ ] Begin Phase 1 implementation
5. [ ] Iterate based on user feedback

---

**Prepared by**: Claude Code
**Date**: 2025-01-14
**Version**: 1.0 (Draft)
